<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4facfe"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wobbles">
    <link rel="apple-touch-icon" href="https://pbs.twimg.com/media/G4x4K1HXAAAPy5X?format=png&name=small">
    
    <title>Wobbles - Virtual Pet Game</title>
    <style>
        /* --- Base Setup --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* JAV√çT√ÅS: Vissza√°ll√≠tva a g√∂rget√©s */
        html, body {
            min-height: 100%; /* Kit√∂lti a k√©perny≈ët, de enged n≈ëni */
            overflow-x: hidden; /* V√≠zszintes g√∂rget√©s tilt√°sa */
            overflow-y: auto;   /* F√ºgg≈ëleges g√∂rget√©s enged√©lyez√©se, HA KELL */
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            -webkit-tap-highlight-color: transparent; 
        }

        .game-container {
            background: white;
            border-radius: 0; 
            box-shadow: none; 
            max-width: 450px; 
            width: 100%;
            overflow: hidden; 
            position: relative;
            min-height: 100vh; /* JAV√çT√ÅS: height: 100%-r√≥l min-height-re */
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px 15px; /* CS√ñKKENTVE */
            text-align: center;
            color: white;
            position: relative;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 32px; /* CS√ñKKENTVE */
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            vertical-align: middle;
            margin-right: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .header-emoji-fallback {
            display: none;
            font-size: 32px; /* CS√ñKKENTVE */
            margin-right: 10px;
            text-shadow: none; /* Already part of h1 */
        }

        .level-badge {
            position: absolute;
            top: 15px;
            left: 20px;
            background: rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        /* --- Stats Bars --- */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px; /* CS√ñKKENTVE */
            padding: 15px; /* CS√ñKKENTVE */
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
            flex-shrink: 0;
        }

        .stat {
            background: white;
            padding: 10px; /* CS√ñKKENTVE */
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        .stat-value {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }

        .stat-bar {
            width: 100%;
            height: 20px; /* CS√ñKKENTVE */
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid #dee2e6;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .stat-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }

        .hunger-fill { background: linear-gradient(90deg, #ff6b6b, #ff8787); }
        .happiness-fill { background: linear-gradient(90deg, #ffd93d, #ffed4e); }
        .health-fill { background: linear-gradient(90deg, #51cf66, #69db7c); }
        .energy-fill { background: linear-gradient(90deg, #4dabf7, #74c0fc); }

        /* --- Pet Area --- */
        .pet-area {
            padding: 10px 20px;
            text-align: center;
            background: linear-gradient(180deg, #e3f2fd 0%, #ffffff 100%);
            flex: 1 1 auto; /* Allow pet-area to grow and shrink */
            min-height: 280px; /* CS√ñKKENTVE */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            transition: filter 0.5s, background 0.5s ease;
        }
        
        /* Background Styles */
        .pet-area.bg-beach {
            background-image: linear-gradient(to bottom, #87ceeb, #f0e68c);
        }
        .pet-area.bg-space {
            background-image: linear-gradient(to bottom, #000033, #330066);
        }
        .pet-area.bg-forest {
            background-image: linear-gradient(to bottom, #90ee90, #228b22);
        }
        .pet-area.bg-volcano {
            background-image: linear-gradient(to bottom, #ff8c00, #d2691e);
        }
        .pet-area.bg-winter {
            background-image: linear-gradient(to bottom, #ffffff, #b0e0e6);
        }

        .coins-display, .xp-display {
            position: absolute;
            top: 15px;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 16px;
            z-index: 2;
        }
        .coins-display { right: 20px; }
        .xp-display { 
            left: 20px; 
            font-size: 14px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .message {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 15px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 10;
            max-width: 80%;
            text-align: center;
        }
        .message.show { opacity: 1; }

        /* --- Status Effect Icon --- */
        .status-effect {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.5s;
            animation: pulse 1.5s ease-in-out infinite;
            text-shadow: 0 0 10px white;
        }
        .status-effect.show { opacity: 1; }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.2); }
        }

        /* --- Wobbles Character --- */
        .wobbles-container {
            position: relative;
            cursor: pointer;
            margin-top: 10px; /* CS√ñKKENTVE */
            z-index: 1;
            transform: scale(var(--pet-scale, 1.0));
            transition: transform 0.5s ease;
        }
        .wobbles-container:active { 
            transform: scale(calc(var(--pet-scale, 1.0) * 0.95)); 
        }

        .wobbles {
            width: 180px;
            height: 180px;
            position: relative;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 20px 15px rgba(0,0,0,0.2));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-20px) rotate(2deg); }
        }

        .wobbles-body {
            width: 180px;
            height: 120px;
            background: linear-gradient(135deg, #4dd0e1 0%, #26c6da 100%);
            border-radius: 50% 50% 50% 50% / 70% 70% 30% 30%;
            position: absolute;
            bottom: 0;
            animation: pulse-body 2s ease-in-out infinite;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.1),
                        inset 10px 10px 20px rgba(255,255,255,0.3);
            z-index: 2;
        }

        @keyframes pulse-body {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .wobbles-shine {
            position: absolute;
            top: 15px;
            left: 30px;
            width: 40px;
            height: 30px;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            filter: blur(5px);
        }

        .wobbles-eye {
            width: 30px;
            height: 35px;
            background: black;
            border-radius: 50%;
            position: absolute;
            top: 35px;
            box-shadow: inset 0 -5px 10px rgba(255,255,255,0.3);
            animation: blink 4s infinite;
        }
        .wobbles-eye.left { left: 45px; }
        .wobbles-eye.right { right: 45px; }

        .wobbles.is-sleeping .wobbles-eye {
            height: 6px;
            top: 50px;
            background: #333;
            border-radius: 3px;
            box-shadow: none;
            animation: none;
        }

        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        .wobbles-eye-shine {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 8px;
            left: 5px;
        }

        .wobbles.is-sleeping .wobbles-eye-shine {
            display: none;
        }

        .wobbles-cheek {
            width: 25px;
            height: 25px;
            background: #ff9eb3;
            border-radius: 50%;
            position: absolute;
            top: 60px;
            opacity: 0.7;
        }
        .wobbles-cheek.left { left: 15px; }
        .wobbles-cheek.right { right: 15px; }

        .wobbles-mouth {
            width: 40px;
            height: 15px;
            border: 4px solid #333;
            border-top: none;
            border-radius: 0 0 40px 40px;
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.3s;
        }
        .wobbles-mouth.happy {
            height: 20px;
            border-radius: 0 0 50px 50px;
            bottom: 20px;
        }
        .wobbles-mouth.sad {
            height: 10px;
            border-radius: 50px 50px 0 0;
            border-top: 4px solid #333;
            border-bottom: none;
            bottom: 30px;
        }


        .wobbles-tentacles {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            width: 150px;
            justify-content: space-around;
        }

        .tentacle {
            width: 18px;
            height: 70px;
            background: linear-gradient(180deg, #4dd0e1 0%, #26c6da 100%);
            border-radius: 20px 20px 10px 10px;
            animation: wiggle 2s ease-in-out infinite;
            box-shadow: inset -3px 0 5px rgba(0,0,0,0.1);
            transform-origin: top center;
        }

        .tentacle:nth-child(1) { animation-delay: 0s; }
        .tentacle:nth-child(2) { animation-delay: 0.2s; height: 75px; }
        .tentacle:nth-child(3) { animation-delay: 0.4s; }
        .tentacle:nth-child(4) { animation-delay: 0.6s; height: 75px; }
        .tentacle:nth-child(5) { animation-delay: 0.8s; }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        .wobbles-shadow {
            width: 120px;
            height: 20px;
            background: rgba(0,0,0,0.15);
            border-radius: 50%;
            position: absolute;
            bottom: -70px;
            left: 50%;
            transform: translateX(-50%);
            filter: blur(5px);
            animation: shadow-pulse 3s ease-in-out infinite;
        }
        
        @keyframes shadow-pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(0.8); }
        }

        /* --- Accessories (Positions Fixed) --- */
        .wobbles-hat {
            width: 80px;
            height: 60px;
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: none;
        }
        .wobbles-hat::before { /* Brim */
            content: '';
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 80px;
            height: 15px;
            background: #333;
            border-radius: 50%;
        }
        .wobbles-hat::after { /* Top */
            content: '';
            position: absolute;
            bottom: 15px;
            left: 15px;
            width: 50px;
            height: 45px;
            background: #333;
            border-radius: 10px 10px 0 0;
            border: 3px solid #444;
        }
        
        .wobbles-party-hat {
            width: 0;
            height: 0;
            border-left: 35px solid transparent;
            border-right: 35px solid transparent;
            border-bottom: 60px solid #f76379;
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%) rotate(-5deg);
            z-index: 10;
            display: none;
        }
        .wobbles-party-hat::before { /* Pompom */
            content: '';
            width: 12px;
            height: 12px;
            background: #f9d71c;
            border-radius: 50%;
            position: absolute;
            top: -70px;
            left: -6px;
        }
        
        /* CROWN FIX: Replaced with better CSS */
        .wobbles-crown {
            width: 70px;
            height: 40px;
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: none;
        }
        .wobbles-crown-base {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 70px;
            height: 10px;
            background: linear-gradient(#ffd700, #f0c000);
            border: 2px solid #b8860b;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .wobbles-crown-prong {
            position: absolute;
            bottom: 8px;
            width: 10px;
            height: 25px;
            background: #ffd700;
            border: 2px solid #b8860b;
            border-bottom: none;
            border-radius: 3px 3px 0 0;
        }
        .wobbles-crown-prong.left {
            left: 10px;
            transform: rotate(-15deg);
        }
        .wobbles-crown-prong.center {
            left: 50%;
            transform: translateX(-50%);
            height: 30px;
        }
        .wobbles-crown-prong.right {
            right: 10px;
            transform: rotate(15deg);
        }
        .wobbles-crown-prong.center::after { /* Gem */
            content: '';
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #ff4136;
            border-radius: 50%;
            border: 1px solid #a00;
        }

        .wobbles-cape {
            width: 100px;
            height: 100px;
            background: #d10000;
            border: 3px solid #a00000;
            position: absolute;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            border-radius: 0 0 50% 50% / 0 0 30% 30%;
            display: none;
        }

        .wobbles-glasses {
            position: absolute;
            top: 95px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: none;
        }
        .wobbles-glasses .lens {
            width: 40px;
            height: 40px;
            background: rgba(20,20,20,0.7);
            border: 3px solid #333;
            border-radius: 50%;
            position: absolute;
            top: 0;
        }
        .wobbles-glasses .lens.left { left: -45px; }
        .wobbles-glasses .lens.right { left: 5px; }
        .wobbles-glasses .bridge {
            width: 10px;
            height: 3px;
            background: #333;
            position: absolute;
            left: -5px;
            top: 18px;
        }

        .wobbles-bowtie {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: none;
        }
        .wobbles-bowtie::before, .wobbles-bowtie::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 15px solid #d63031;
            border-top-width: 10px;
            border-bottom-width: 10px;
        }
        .wobbles-bowtie::before {
            border-right: 10px solid transparent;
            border-left-color: #e17055;
            left: -15px;
            border-radius: 5px 0 0 5px;
        }
        .wobbles-bowtie::after {
            border-left: 10px solid transparent;
            border-right-color: #e17055;
            left: 5px;
            border-radius: 0 5px 5px 0;
        }
        
        .quest-display {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            border: 2px solid #ffd700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 5;
            display: none;
            white-space: nowrap;
        }

        /* --- Action Buttons --- */
        .actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px; /* CS√ñKKENTVE */
            padding: 15px; /* CS√ñKKENTVE */
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 10px; /* CS√ñKKENTVE */
            border-radius: 18px;
            font-size: 24px; /* CS√ñKKENTVE */
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .action-btn:disabled {
            filter: grayscale(80%);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transition: left 0.3s;
        }
        .action-btn:not(:disabled):hover::before { left: 100%; }
        .action-btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .action-btn:not(:disabled):active { transform: translateY(0); }

        .action-btn.feed { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); }
        .action-btn.play { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .action-btn.heal { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .action-btn.water { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .action-btn.sleep { background: linear-gradient(135deg, #a8edea, #fed6e3); }
        .action-btn.clean { background: linear-gradient(135deg, #ffecd2, #fcb69f); }

        .action-label {
            font-size: 10px; /* CS√ñKKENTVE */
            margin-top: 4px; /* CS√ñKKENTVE */
            display: block;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        /* --- Emoji/Particle Animations --- */
        .emoji {
            font-size: 24px;
            position: absolute;
            animation: float-up 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 5;
        }

        .zzz-particle {
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            color: #999;
            top: 50%;
            left: 60%;
            animation: float-up-zzz 2.5s ease-out forwards;
            pointer-events: none;
            z-index: 5;
            opacity: 0.8;
        }
        @keyframes float-up-zzz {
            from {
                opacity: 0.8;
                transform: translateY(0) scale(0.8) translateX(0);
            }
            to {
                opacity: 0;
                transform: translateY(-100px) scale(1.2) translateX(15px);
            }
        }

        @keyframes float-up {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-120px) scale(1.5); }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            animation: particle-float 2s ease-out forwards;
            z-index: 5;
        }

        @keyframes particle-float {
            from { opacity: 1; transform: translate(0, 0) rotate(0deg); }
            to { opacity: 0; transform: translate(var(--tx), var(--ty)) rotate(360deg); }
        }
        
        /* NEW: Side Action Containers */
        .side-actions-left, .side-actions-right {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 5;
        }
        .side-actions-left { left: 15px; }
        .side-actions-right { right: 15px; }

        /* NEW: Base Side Action Button Style */
        .side-action-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(255,255,255,0.5));
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.9);
            color: #333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .side-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .side-action-btn:active {
            transform: scale(0.95);
        }
        
        /* MODIFIED: Daily Reward Button */
        #dailyRewardBtn {
            position: relative; /* No longer absolute */
            top: auto;
            left: auto;
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); /* Keep special color */
            color: white;
            border: none;
            /* width, height, font-size, etc. all come from .side-action-btn */
            display: none; /* Hidden by default */
            animation: pulse-reward 1.5s infinite;
        }

        @keyframes pulse-reward {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* JAV√çT√ÅS: Az "Extras" s√°v ALAP√âRTELMEZETTEN elrejt√©se */
        .extras-section {
            display: none;
        }


        /* --- Modals --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            padding-top: 20px;
            padding-bottom: 20px;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 0 auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus {
            color: black;
        }
        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .modal-subtitle {
            font-size: 16px;
            font-weight: bold;
            color: #555;
            text-align: center;
            margin-top: 15px;
            margin-bottom: 10px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        /* --- Shop Modal (REFACTORED) --- */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .shop-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            margin-bottom: 0;
            border-radius: 10px;
            background: #f9f9f9;
            border: 1px solid #eee;
        }
        .shop-item-icon {
            font-size: 40px;
            line-height: 1;
            margin-bottom: 10px;
        }
        .shop-item span {
            font-size: 13px;
            font-weight: bold;
            text-align: center;
        }
        .buy-btn {
            background: linear-gradient(135deg, #51cf66, #69db7c);
            color: white;
            border: none;
            padding: 8px 15px;
            margin-top: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .buy-btn:hover { background: linear-gradient(135deg, #69db7c, #51cf66); }
        .buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* NEW: Button style for games modal */
        .modal-content .extra-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            /* Alap st√≠lus (Mem√≥ria J√°t√©k) */
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            cursor: pointer;
        }
        .modal-content .extra-btn.reaction {
             background: linear-gradient(135deg, #51cf66, #69db7c);
        }
        .modal-content .extra-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }


        /* --- Memory Game Modal --- */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
            perspective: 1000px;
        }
        .memory-card {
            width: 100%;
            padding-top: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .memory-card.is-flipped {
            transform: rotateY(180deg);
        }
        .memory-card.is-matched {
            opacity: 0.5;
            pointer-events: none;
        }
        .memory-card-face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .memory-card-face.card-front {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 50px;
        }
        .memory-card-face.card-back {
            background: #fff;
            border: 2px solid #f093fb;
            transform: rotateY(180deg);
        }
        #memoryMessage {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
            min-height: 1.2em;
        }
        #memoryRestartBtn {
            width: 100%;
            margin-top: 10px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        /* --- Wardrobe Modal (REFACTORED) --- */
        .wardrobe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .wardrobe-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            margin-bottom: 0;
            border-radius: 10px;
            background: #f9f9f9;
            border: 2px solid #eee;
        }
        .wardrobe-item-icon {
            font-size: 40px;
            line-height: 1;
            margin-bottom: 10px;
        }
        .wardrobe-item span {
            font-size: 13px;
            font-weight: bold;
            text-align: center;
        }
        .toggle-btn {
            background: linear-gradient(135deg, #51cf66, #69db7c);
            color: white;
            border: none;
            padding: 8px 15px;
            margin-top: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            min-width: 80px;
            text-align: center;
        }
        .toggle-btn.is-equipped {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        }
        .toggle-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .wardrobe-item.is-equipped {
            border-color: #51cf66;
            box-shadow: 0 0 10px rgba(81, 207, 102, 0.5);
        }

        /* --- Reaction Game Modal (UPDATED) --- */
        #reactionArea {
            height: 300px;
            background: #f0f4f8;
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 3px solid #dcdcdc;
        }
        .reaction-fruit-item {
            font-size: 50px;
            position: absolute;
            top: -60px;
            cursor: pointer;
        }
        #reactionStartBtn {
            width: 100%;
            background: linear-gradient(135deg, #51cf66, #69db7c);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        #reactionMessage {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
            min-height: 1.2em;
        }
        #reactionStats {
            font-size: 16px;
            text-align: center;
            font-weight: bold;
            margin-top: -10px;
            margin-bottom: 15px;
        }
        @keyframes fall {
            from { top: -60px; }
            to { top: 300px; }
        }
        
        /* Media query for desktop/large screens */
        @media (min-width: 451px) {
            body {
                align-items: center;
                padding: 20px;
                height: auto; /* Allow body to be auto height */
                overflow: auto; /* Allow body scrolling */
            }
            .game-container {
                min-height: auto;
                height: auto; /* Auto height on desktop */
                border-radius: 25px;
                box-shadow: 0 25px 70px rgba(0,0,0,0.4);
                overflow: hidden; /* Hide overflow on desktop too */
            }

            .pet-area {
                flex: 0 1 auto;
                min-height: 380px;
                padding: 30px 20px;
            }

            .wobbles-container {
                margin-top: 20px;
            }
            
            /* JAV√çT√ÅS: T√ñRL√ñLVE az oldals√≥ gombokat elrejt≈ë szab√°lyok */
            /* JAV√çT√ÅS: T√ñRL√ñLVE az als√≥ s√°vot megjelen√≠t≈ë szab√°ly */
        }
        
        /* JAV√çT√ÅS: T√ñRL√ñLVE a max-width: 450px media query, mert felesleges */

    </style>
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <div class="header">
            <div class="level-badge">‚≠ê Lvl <span id="level">1</span></div>
            <h1>
                <img src="https://pbs.twimg.com/media/G4x4K1HXAAAPy5X?format=png&name=small" alt="Wobbles Logo" class="header-logo" onerror="this.style.display='none'; document.getElementById('headerEmojiFallback').style.display='inline';">
                <span id="headerEmojiFallback" class="header-emoji-fallback">üêô</span>
                 WOBBLES
            </h1>
        </div>

        <!-- Stats -->
        <div class="stats-container">
            <div class="stat">
                <div class="stat-header">
                    <span class="stat-label">üçî Hunger</span>
                    <span class="stat-value" id="hungerValue">100%</span>
                </div>
                <div class="stat-bar">
                    <div class="stat-fill hunger-fill" id="hungerBar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-header">
                    <span class="stat-label">üòä Happiness</span>
                    <span class="stat-value" id="happyValue">100%</span>
                </div>
                <div class="stat-bar">
                    <div class="stat-fill happiness-fill" id="happyBar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-header">
                    <span class="stat-label">‚ù§Ô∏è Health</span>
                    <span class="stat-value" id="healthValue">100%</span>
                </div>
                <div class="stat-bar">
                    <div class="stat-fill health-fill" id="healthBar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-header">
                    <span class="stat-label">‚ö° Energy</span>
                    <span class="stat-value" id="energyValue">100%</span>
                </div>
                <div class="stat-bar">
                    <div class="stat-fill energy-fill" id="energyBar" style="width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Pet Area -->
        <div class="pet-area" id="petArea">
            <div class="xp-display">‚ú® XP: <span id="xp">0</span></div>
            <div class="coins-display" id="coins">üí∞ 0</div>
            <div class="message" id="message"></div>
            <div class="status-effect" id="statusIcon"></div>
            
            <!-- NEW: Side Action Buttons -->
            <div class="side-actions-left">
                <!-- Daily Reward Button MOVED here -->
                <button id="dailyRewardBtn" class="side-action-btn" onclick="claimDailyReward()">üéÅ</button>
            </div>
            <div class="side-actions-right">
                <button class="side-action-btn" onclick="openShop()">üõí</button>
                <button class="side-action-btn" onclick="openWardrobe()">üëö</button>
                <button class="side-action-btn" onclick="openGamesModal()">üéÆ</button> 
            </div>
            
            <div class="wobbles-container" id="wobbles" onclick="petWobbles()">
                <div class="wobbles">
                    <div class="wobbles-cape" id="wobblesCape"></div>
                    
                    <!-- Accessories -->
                    <div class="wobbles-hat" id="wobblesHat"></div>
                    <div class="wobbles-party-hat" id="wobblesPartyHat"></div>
                    <!-- CROWN FIX: New HTML Structure -->
                    <div class="wobbles-crown" id="wobblesCrown">
                        <div class="wobbles-crown-prong left"></div>
                        <div class="wobbles-crown-prong center"></div>
                        <div class="wobbles-crown-prong right"></div>
                        <div class="wobbles-crown-base"></div>
                    </div>
                    <div class="wobbles-glasses" id="wobblesGlasses">
                        <div class="lens left"></div>
                        <div class="bridge"></div>
                        <div class="lens right"></div>
                    </div>
                    <div class="wobbles-bowtie" id="wobblesBowtie"></div>
                    
                    <!-- Character -->
                    <div class="wobbles-body">
                        <div class="wobbles-shine"></div>
                        <div class="wobbles-eye left">
                            <div class="wobbles-eye-shine"></div>
                        </div>
                        <div class="wobbles-eye right">
                            <div class="wobbles-eye-shine"></div>
                        </div>
                        <div class="wobbles-cheek left"></div>
                        <div class="wobbles-cheek right"></div>
                        <div class="wobbles-mouth" id="wobblesMouth"></div>
                    </div>
                    <div class="wobbles-tentacles">
                        <div class="tentacle"></div>
                        <div class="tentacle"></div>
                        <div class="tentacle"></div>
                        <div class="tentacle"></div>
                        <div class="tentacle"></div>
                    </div>
                    <div class="wobbles-shadow"></div>
                </div>
            </div>
            
            <div class="quest-display" id="questDisplay">Quest: Loading...</div>
        </div>

        <!-- Actions -->
        <div class="actions">
            <button class="action-btn feed" id="btn-feed" onclick="feedWobbles()">
                üçï
                <span class="action-label">Feed</span>
            </button>
            <button class="action-btn play" id="btn-play" onclick="playWithWobbles()">
                ‚öΩ
                <span class="action-label">Play</span>
            </button>
            <button class="action-btn heal" id="btn-heal" onclick="healWobbles()">
                üíä
                <span class="action-label">Heal</span>
            </button>
            <button class="action-btn water" id="btn-water" onclick="giveWater()">
                üíß
                <span class="action-label">Water</span>
            </button>
            <button class="action-btn sleep" id="btn-sleep" onclick="putToSleep()">
                üò¥
                <span class="action-label">Sleep</span>
            </button>
            <button class="action-btn clean" id="btn-clean" onclick="cleanWobbles()">
                üõÅ
                <span class="action-label">Clean</span>
            </button>
        </div>

        <!-- Extras (REMOVED from mobile, visible on desktop) -->
        <div class="extras-section">
            <div class="extras-title">üéÅ Extras</div>
            <button class="extra-btn" onclick="openMemoryGame()">üß† Memory Game</button>
            <button class="extra-btn reaction" onclick="openReactionGame()">üçì Catch Fruit</button>
            <button class="extra-btn shop" onclick="openShop()">üõí Shop</button>
            <button class="extra-btn wardrobe" onclick="openWardrobe()">üëö Wardrobe</button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeShop()">&times;</span>
            <h2>üõí Wobbles Mart üõí</h2>
            
            <div class="modal-subtitle">Accessories</div>
            <div class="shop-grid" id="shopAccessoryGrid">
                <!-- Dinamikusan gener√°lt tartalom -->
            </div>
            
            <div class="modal-subtitle">Backgrounds</div>
            <div class="shop-grid" id="shopBackgroundGrid">
                <!-- Dinamikusan gener√°lt tartalom -->
            </div>

            <div class="modal-subtitle">Consumables</div>
            <div class="shop-item">
                <div class="shop-item-icon">üçé</div>
                <span>Super Food</span>
                <button class="buy-btn" id="buyBtnFood" onclick="buyItem('food', 30)">üí∞ 30</button>
            </div>
        </div>
    </div>

    <!-- Memory Game Modal -->
    <div id="memoryModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMemoryGame()">&times;</span>
            <h2>üß† Memory Game üß†</h2>
            <p id="memoryMessage">Match all the pairs! (Cost: 10 Energy)</p>
            <div class="memory-grid" id="memoryGrid">
                <!-- Cards will be generated by JS -->
            </div>
            <button id="memoryRestartBtn" class="extra-btn" onclick="startMemoryGame()">Restart Game</button>
        </div>
    </div>

    <!-- Reaction Game Modal -->
    <div id="reactionModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeReactionGame()">&times;</span>
            <h2>üçì Catch the Fruit! üçì</h2>
            <p id="reactionMessage">Click the fruit before it falls! (Cost: 10 Energy)</p>
            <div id="reactionStats">Score: <span id="reactionScore">0</span> | Lives: <span id="reactionLives">3</span></div>
            <div id="reactionArea">
                <!-- Fruits will be spawned here by JS -->
            </div>
            <button id="reactionStartBtn" class="extra-btn" onclick="startReactionGame()">Start Game</button>
        </div>
    </div>

    <!-- Wardrobe Modal -->
    <div id="wardrobeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeWardrobe()">&times;</span>
            <h2>üëö Wardrobe üëö</h2>
            
            <div class="modal-subtitle">Accessories</div>
            <div class="wardrobe-grid" id="wardrobeAccessoryGrid">
                <!-- Dinamikusan gener√°lt tartalom -->
            </div>

            <div class="modal-subtitle">Backgrounds</div>
            <div class="wardrobe-grid" id="wardrobeBackgroundGrid">
                <!-- Dinamikusan gener√°lt tartalom -->
            </div>
        </div>
    </div>
    
    <!-- Daily Reward Modal -->
    <div id="dailyRewardModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close-btn" onclick="closeModal('dailyRewardModal')">&times;</span>
            <h2 class="modal-title">üéÅ Daily Reward!</h2>
            <p style="font-size: 18px; margin-bottom: 20px;">Welcome back! You received üí∞ 100 Coins!</p>
            <button class="buy-btn" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);" onclick="closeModal('dailyRewardModal')">Awesome!</button>
        </div>
    </div>
    
    <!-- NEW: Games Modal -->
    <div id="gamesModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close-btn" onclick="closeModal('gamesModal')">&times;</span>
            <h2 class="modal-title">üéÆ Mini-Games üéÆ</h2>
            <p style="font-size: 16px; margin-bottom: 20px;">Which game do you want to play?</p>
            <button class="extra-btn" onclick="openMemoryGame()" style="margin-bottom: 10px;">üß† Memory Game</button>
            <button class="extra-btn reaction" onclick="openReactionGame()">üçì Catch Fruit</button>
        </div>
    </div>


    <script>
        // --- APK FIX 2: DOMContentLoaded ---
        document.addEventListener("DOMContentLoaded", function() {

            function createDefaultGameState() {
                return {
                    hunger: 100,
                    happiness: 100,
                    health: 100,
                    energy: 100,
                    coins: 0,
                    xp: 0,
                    level: 1,
                    lastUpdate: Date.now(),
                    petCount: 0,
                    inventory: [], 
                    equipped: {
                        hat: 'none',
                        glasses: false,
                        bowtie: false,
                        crown: false,
                        cape: false,
                        background: 'default'
                    },
                    isSleeping: false,
                    sleepIntervalId: null,
                    lastDailyReward: null,
                    activeQuest: null,
                    questProgress: 0
                };
            }

            let gameState = createDefaultGameState();

            const ui = {
                hungerBar: document.getElementById('hungerBar'),
                happyBar: document.getElementById('happyBar'),
                healthBar: document.getElementById('healthBar'),
                energyBar: document.getElementById('energyBar'),
                hungerValue: document.getElementById('hungerValue'),
                happyValue: document.getElementById('happyValue'),
                healthValue: document.getElementById('healthValue'),
                energyValue: document.getElementById('energyValue'),
                coins: document.getElementById('coins'),
                xp: document.getElementById('xp'),
                level: document.getElementById('level'),
                message: document.getElementById('message'),
                petArea: document.getElementById('petArea'),
                wobblesMouth: document.getElementById('wobblesMouth'),
                wobblesContainer: document.getElementById('wobbles'),
                statusIcon: document.getElementById('statusIcon'),
                // Accessories
                wobblesHat: document.getElementById('wobblesHat'),
                wobblesPartyHat: document.getElementById('wobblesPartyHat'),
                wobblesGlasses: document.getElementById('wobblesGlasses'),
                wobblesBowtie: document.getElementById('wobblesBowtie'),
                wobblesCrown: document.getElementById('wobblesCrown'),
                wobblesCape: document.getElementById('wobblesCape'),
                // Shop
                shopModal: document.getElementById('shopModal'),
                shopAccessoryGrid: document.getElementById('shopAccessoryGrid'),
                shopBackgroundGrid: document.getElementById('shopBackgroundGrid'),
                buyBtnFood: document.getElementById('buyBtnFood'),
                actionButtons: document.querySelectorAll('.action-btn, .side-action-btn'), // MODIFIED
                // Memory Game
                memoryModal: document.getElementById('memoryModal'),
                memoryGrid: document.getElementById('memoryGrid'),
                memoryMessage: document.getElementById('memoryMessage'),
                memoryRestartBtn: document.getElementById('memoryRestartBtn'),
                // Reaction Game
                reactionModal: document.getElementById('reactionModal'),
                reactionMessage: document.getElementById('reactionMessage'),
                reactionArea: document.getElementById('reactionArea'),
                reactionStartBtn: document.getElementById('reactionStartBtn'),
                reactionScore: document.getElementById('reactionScore'),
                reactionLives: document.getElementById('reactionLives'),
                // Wardrobe
                wardrobeModal: document.getElementById('wardrobeModal'),
                wardrobeAccessoryGrid: document.getElementById('wardrobeAccessoryGrid'),
                wardrobeBackgroundGrid: document.getElementById('wardrobeBackgroundGrid'),
                // Daily Reward
                dailyRewardBtn: document.getElementById('dailyRewardBtn'),
                dailyRewardModal: document.getElementById('dailyRewardModal'),
                // Quest
                questDisplay: document.getElementById('questDisplay'),
                // Games
                gamesModal: document.getElementById('gamesModal') // NEW
            };

            const shopItems = {
                accessories: [
                    { id: 'tophat', name: 'Top Hat', price: 50, icon: 'üé©' },
                    { id: 'partyhat', name: 'Party Hat', price: 60, icon: 'üéâ' },
                    { id: 'glasses', name: 'Glasses', price: 75, icon: 'üòé' },
                    { id: 'bowtie', name: 'Bowtie', price: 40, icon: 'üéÄ' },
                    { id: 'crown', name: 'Crown', price: 500, icon: 'üëë' },
                    { id: 'cape', name: 'Hero Cape', price: 400, icon: 'ü¶∏' }
                ],
                backgrounds: [
                    { id: 'beach', name: 'Beach', price: 150, icon: 'üèñÔ∏è' },
                    { id: 'space', name: 'Space', price: 250, icon: 'üöÄ' },
                    { id: 'forest', name: 'Forest', price: 200, icon: 'üå≤' },
                    { id: 'volcano', name: 'Volcano', price: 200, icon: 'üåã' },
                    { id: 'winter', name: 'Winter', price: 200, icon: '‚ùÑÔ∏è' }
                ]
            };
            
            const quests = [
                { id: 'play_3_games', title: 'Quest: Play 3 mini-games', target: 3, reward: 50, type: 'game' },
                { id: 'feed_5_times', title: 'Quest: Feed Wobbles 5 times', target: 5, reward: 30, type: 'feed' },
                { id: 'clean_2_times', title: 'Quest: Clean Wobbles 2 times', target: 2, reward: 20, type: 'clean' },
                { id: 'pet_10_times', title: 'Quest: Pet Wobbles 10 times', target: 10, reward: 25, type: 'pet' }
            ];
            
            let memoryGameActive = false;
            let firstCard = null;
            let secondCard = null;
            let lockBoard = false;
            let pairsMatched = 0;
            const cardEmojis = ['üçï', '‚öΩ', 'üíä', 'üíß', 'üõÅ', '‚≠ê', 'üé©', 'üòé'];

            let reactionGameState = 'idle';
            let reactionGameScore = 0;
            let reactionGameLives = 3;
            let reactionSpawnInterval = null;
            let reactionGameTimer = null;


            // --- Core Game Logic ---

            function gameLoop() {
                if (gameState.isSleeping) return;

                const now = Date.now();
                const deltaSeconds = (now - gameState.lastUpdate) / 1000;

                gameState.hunger = Math.max(0, gameState.hunger - deltaSeconds * 0.3);
                gameState.happiness = Math.max(0, gameState.happiness - deltaSeconds * 0.2);
                gameState.energy = Math.max(0, gameState.energy - deltaSeconds * 0.1);

                if (gameState.hunger === 0) {
                    gameState.health = Math.max(0, gameState.health - deltaSeconds * 0.5);
                }
                if (gameState.happiness === 0) {
                    gameState.health = Math.max(0, gameState.health - deltaSeconds * 0.5);
                }

                if (gameState.health === 0) {
                    showMessage("Oh no! Wobbles fainted! Restarting game...");
                    try {
                        localStorage.removeItem('wobblesGame');
                    } catch (e) {
                        console.error("Failed to clear save on game over:", e);
                    }
                    setTimeout(() => location.reload(), 2000);
                }

                gameState.lastUpdate = now;
                updateUI();
                saveGame();
            }

            function updateUI() {
                ui.hungerBar.style.width = gameState.hunger + '%';
                ui.happyBar.style.width = gameState.happiness + '%';
                ui.healthBar.style.width = gameState.health + '%';
                ui.energyBar.style.width = gameState.energy + '%';
                
                ui.hungerValue.textContent = Math.round(gameState.hunger) + '%';
                ui.happyValue.textContent = Math.round(gameState.happiness) + '%';
                ui.healthValue.textContent = Math.round(gameState.health) + '%';
                ui.energyValue.textContent = Math.round(gameState.energy) + '%';
                
                ui.coins.textContent = 'üí∞ ' + gameState.coins;
                ui.xp.textContent = gameState.xp;
                ui.level.textContent = gameState.level;
                
                ui.wobblesMouth.classList.remove('happy', 'sad');
                if (gameState.happiness > 60) {
                    ui.wobblesMouth.classList.add('happy');
                } else if (gameState.happiness < 30) {
                    ui.wobblesMouth.classList.add('sad');
                }
                
                let status = '';
                if (gameState.health < 30) status = 'ü§¢';
                else if (gameState.hunger < 30) status = 'üò´';
                else if (gameState.happiness < 30) status = 'üò¢';
                else if (gameState.energy < 20) status = 'üò¥';
                
                if (status) {
                    ui.statusIcon.textContent = status;
                    ui.statusIcon.classList.add('show');
                } else {
                    ui.statusIcon.classList.remove('show');
                }

                updateAccessories();
                updateBackground();
                checkEvolution();
                updateQuestDisplay();

                const requiredXP = gameState.level * 100;
                if (gameState.xp >= requiredXP) {
                    levelUp();
                }
            }
            
            function updateAccessories() {
                ui.wobblesHat.style.display = gameState.equipped.hat === 'tophat' ? 'block' : 'none';
                ui.wobblesPartyHat.style.display = gameState.equipped.hat === 'partyhat' ? 'block' : 'none';
                ui.wobblesGlasses.style.display = gameState.equipped.glasses ? 'block' : 'none';
                ui.wobblesBowtie.style.display = gameState.equipped.bowtie ? 'block' : 'none';
                ui.wobblesCrown.style.display = gameState.equipped.crown ? 'block' : 'none';
                ui.wobblesCape.style.display = gameState.equipped.cape ? 'block' : 'none';
            }
            
            function updateBackground() {
                const bgId = gameState.equipped.background || 'default';
                ui.petArea.className = 'pet-area';
                if (bgId !== 'default') {
                    ui.petArea.classList.add(`bg-${bgId}`);
                }
            }
            
            function checkEvolution() {
                let scale = 1.0;
                if (gameState.level >= 10) {
                    scale = 1.2;
                } else if (gameState.level >= 5) {
                    scale = 1.1;
                }
                ui.wobblesContainer.style.setProperty('--pet-scale', scale);
            }

            function levelUp() {
                gameState.level++;
                gameState.xp -= (gameState.level - 1) * 100;
                gameState.coins += 100;
                showMessage(`üéâ Level Up! You are now Level ${gameState.level}!`);
                createParticles('‚≠ê', 15);
            }

            // --- APK FIX 1: Safe Save/Load ---
            function saveGame() {
                try {
                    localStorage.setItem('wobblesGame', JSON.stringify(gameState));
                } catch (e) {
                    console.error("Failed to save game:", e);
                }
            }

            function loadGame() {
                let savedGame;
                try {
                    savedGame = localStorage.getItem('wobblesGame');
                } catch (e) {
                    console.error("Failed to read saved game:", e);
                    savedGame = null;
                }
                
                if (savedGame) {
                    try {
                        let loadedState = JSON.parse(savedGame);
                        
                        // --- Migration from old `itemsOwned` object to `inventory` array ---
                        if (loadedState.itemsOwned && !loadedState.inventory) {
                            console.log("Migrating old save file to new inventory system...");
                            loadedState.inventory = [];
                            if (loadedState.itemsOwned.tophat) loadedState.inventory.push('tophat');
                            if (loadedState.itemsOwned.partyhat) loadedState.inventory.push('partyhat');
                            if (loadedState.itemsOwned.glasses) loadedState.inventory.push('glasses');
                            if (loadedState.itemsOwned.bowtie) loadedState.inventory.push('bowtie');
                            if (loadedState.itemsOwned.crown) loadedState.inventory.push('crown');
                            if (loadedState.itemsOwned.cape) loadedState.inventory.push('cape');
                            if (loadedState.itemsOwned.bg_beach) loadedState.inventory.push('beach');
                            if (loadedState.itemsOwned.bg_space) loadedState.inventory.push('space');
                            if (loadedState.itemsOwned.bg_forest) loadedState.inventory.push('forest');
                            if (loadedState.itemsOwned.bg_volcano) loadedState.inventory.push('volcano');
                            if (loadedState.itemsOwned.bg_winter) loadedState.inventory.push('winter');
                            
                            delete loadedState.itemsOwned;
                        }

                        // --- ROBUST STATE MERGE (FIXES NaN BUG) ---
                        let newGameState = createDefaultGameState(); 
                        
                        for (let key in newGameState) {
                            if (loadedState.hasOwnProperty(key)) {
                                if (key === 'equipped' && typeof loadedState[key] === 'object' && loadedState[key] !== null) {
                                    newGameState[key] = { ...newGameState[key], ...loadedState[key] };
                                } else if (loadedState[key] !== undefined && loadedState[key] !== null) {
                                    newGameState[key] = loadedState[key];
                                }
                            }
                        }
                        
                        gameState = newGameState;
                        // --- END SAFE STATE MERGE ---
                        
                        if (!gameState.inventory.includes('default')) {
                            gameState.inventory.push('default');
                        }

                        // Calculate "offline" progress
                        const now = Date.now();
                        const deltaSeconds = (now - gameState.lastUpdate) / 1000;
                        
                        if (!gameState.isSleeping) {
                            gameState.hunger = Math.max(0, gameState.hunger - deltaSeconds * 0.3);
                            gameState.happiness = Math.max(0, gameState.happiness - deltaSeconds * 0.2);
                            gameState.energy = Math.max(0, gameState.energy - deltaSeconds * 0.1);
                            if (gameState.hunger === 0) gameState.health = Math.max(0, gameState.health - deltaSeconds * 0.5);
                            if (gameState.happiness === 0) gameState.health = Math.max(0, gameState.health - deltaSeconds * 0.5);
                        } else {
                            gameState.energy = Math.min(100, gameState.energy + deltaSeconds * 2);
                            gameState.health = Math.min(100, gameState.health + deltaSeconds * 0.5);
                            if (gameState.energy >= 100) {
                                gameState.isSleeping = false;
                            }
                        }

                        gameState.lastUpdate = now;
                        showMessage("Welcome back!");

                        if (gameState.isSleeping) {
                            document.getElementById('wobbles').classList.add('is-sleeping');
                            setButtonsDisabled(true);
                            ui.petArea.style.filter = 'brightness(0.3)';
                            document.getElementById('btn-sleep').disabled = false;
                            document.getElementById('btn-sleep').innerHTML = '‚òÄÔ∏è<span class="action-label">Wake Up</span>';
                            gameState.sleepIntervalId = setInterval(createSleepZzz, 800);
                        }

                    } catch(e) {
                        console.error('Starting new game, corrupted save.', e);
                        try {
                            localStorage.removeItem('wobblesGame');
                        } catch (removeError) {
                            console.error("Failed to remove corrupted save:", removeError);
                        }
                        gameState = createDefaultGameState();
                        gameState.lastUpdate = Date.now();
                        if (!gameState.inventory.includes('default')) {
                             gameState.inventory.push('default');
                        }
                    }
                } else {
                    gameState = createDefaultGameState();
                    gameState.lastUpdate = Date.now();
                    if (!gameState.inventory.includes('default')) {
                         gameState.inventory.push('default');
                    }
                }
            }

            // --- UI Helpers ---

            function showMessage(text) {
                ui.message.textContent = text;
                ui.message.classList.add('show');
                setTimeout(() => ui.message.classList.remove('show'), 2500);
            }

            function createEmoji(emoji) {
                const emojiEl = document.createElement('div');
                emojiEl.className = 'emoji';
                emojiEl.textContent = emoji;
                emojiEl.style.left = (Math.random() * 70 + 15) + '%';
                emojiEl.style.top = '45%';
                ui.petArea.appendChild(emojiEl);
                setTimeout(() => emojiEl.remove(), 1500);
            }

            function createSleepZzz() {
                if (!gameState.isSleeping) return;
                const zzzEl = document.createElement('div');
                zzzEl.className = 'zzz-particle';
                zzzEl.textContent = 'z';
                setTimeout(() => { if (gameState.isSleeping) zzzEl.textContent = 'Zz'; }, 500);
                setTimeout(() => { if (gameState.isSleeping) zzzEl.textContent = 'Zzz'; }, 1000);
                
                zzzEl.style.left = (Math.random() * 30 + 55) + '%';
                zzzEl.style.top = '40%';
                ui.petArea.appendChild(zzzEl);
                setTimeout(() => zzzEl.remove(), 2500);
            }

            function createParticles(emoji, count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.textContent = emoji;
                        particle.style.left = '50%';
                        particle.style.top = '50%';
                        particle.style.fontSize = (Math.random() * 20 + 15) + 'px';
                        particle.style.setProperty('--tx', (Math.random() * 200 - 100) + 'px');
                        particle.style.setProperty('--ty', (Math.random() * 200 - 100) + 'px');
                        ui.petArea.appendChild(particle);
                        setTimeout(() => particle.remove(), 2000);
                    }, i * 50);
                }
            }

            function setButtonsDisabled(disabled) {
                // MODIFIED: Query selector now finds .action-btn and .side-action-btn
                document.querySelectorAll('.action-btn, .side-action-btn').forEach(btn => {
                    // Ne tiltsuk le a napi jutalmat
                    if (btn.id === 'dailyRewardBtn' && disabled) {
                        return;
                    }
                    btn.disabled = disabled;
                });
            }
            
            // --- Pet Actions ---
            window.feedWobbles = function() {
                if (gameState.hunger < 100) {
                    gameState.hunger = Math.min(100, gameState.hunger + 25);
                    gameState.energy = Math.min(100, gameState.energy + 10);
                    gameState.coins += 8;
                    gameState.xp += 10;
                    showMessage('Yum yum! üçï That was delicious!');
                    createEmoji('üçï');
                    createParticles('‚ú®', 5);
                    progressQuest('feed');
                    updateUI();
                } else {
                    showMessage("I'm full! üòä");
                }
            }

            window.playWithWobbles = function() {
                if (gameState.energy > 20) {
                    gameState.happiness = Math.min(100, gameState.happiness + 30);
                    gameState.hunger = Math.max(0, gameState.hunger - 15);
                    gameState.energy = Math.max(0, gameState.energy - 20);
                    gameState.coins += 15;
                    gameState.xp += 20;
                    showMessage('Woohoo! üéâ That was so much fun!');
                    createEmoji('‚öΩ');
                    createParticles('üéà', 8);
                    updateUI();
                } else {
                    showMessage("I'm too tired to play! üò¥");
                }
            }

            window.healWobbles = function() {
                if (gameState.health < 100) {
                    gameState.health = Math.min(100, gameState.health + 35);
                    gameState.coins += 10;
                    gameState.xp += 15;
                    showMessage('I feel so much better! üíö');
                    createEmoji('üíä');
                    createParticles('üíö', 6);
                    updateUI();
                } else {
                    showMessage("I'm already perfectly healthy! üí™");
                }
            }

            window.giveWater = function() {
                gameState.hunger = Math.min(100, gameState.hunger + 10);
                gameState.health = Math.min(100, gameState.health + 5);
                gameState.energy = Math.min(100, gameState.energy + 5);
                gameState.coins += 5;
                gameState.xp += 8;
                showMessage('Aaah, refreshing! üíß');
                createEmoji('üíß');
                createParticles('üí¶', 5);
                updateUI();
            }

            window.putToSleep = function() {
                if (gameState.isSleeping) {
                    wakeUp();
                } else {
                    if (gameState.energy < 90) {
                        gameState.isSleeping = true;
                        document.getElementById('wobbles').classList.add('is-sleeping');
                        showMessage('Zzz... Wobbles is taking a nap... üò¥üí§');
                        createEmoji('üí§');
                        setButtonsDisabled(true);
                        ui.petArea.style.filter = 'brightness(0.3)';
                        document.getElementById('btn-sleep').disabled = false;
                        document.getElementById('btn-sleep').innerHTML = '‚òÄÔ∏è<span class="action-label">Wake Up</span>';
                        
                        gameState.sleepIntervalId = setInterval(createSleepZzz, 800); 

                        const sleepRegenInterval = setInterval(() => {
                            if (!gameState.isSleeping) {
                                clearInterval(sleepRegenInterval);
                                return;
                            }
                            gameState.energy = Math.min(100, gameState.energy + 2);
                            gameState.health = Math.min(100, gameState.health + 0.5);
                            if (gameState.energy === 100) {
                                wakeUp();
                            }
                            updateUI();
                        }, 200);

                    } else {
                        showMessage("I'm not tired! ‚ö°");
                    }
                }
            }
            
            function wakeUp() {
                gameState.isSleeping = false;
                document.getElementById('wobbles').classList.remove('is-sleeping');
                if (gameState.sleepIntervalId) {
                    clearInterval(gameState.sleepIntervalId);
                    gameState.sleepIntervalId = null;
                }
                showMessage('Yawn! That was a great nap! ‚òÄÔ∏è');
                setButtonsDisabled(false);
                ui.petArea.style.filter = 'brightness(1)';
                document.getElementById('btn-sleep').innerHTML = 'üò¥<span class="action-label">Sleep</span>';
                updateUI();
            }

            window.cleanWobbles = function() {
                gameState.health = Math.min(100, gameState.health + 15);
                gameState.happiness = Math.min(100, gameState.happiness + 10);
                gameState.coins += 8;
                gameState.xp += 12;
                showMessage('So clean and sparkly! ‚ú®üõÅ');
                createEmoji('‚ú®');
                createParticles('üßº', 6);
                progressQuest('clean');
                updateUI();
            }

            window.petWobbles = function() {
                if (gameState.isSleeping) {
                    showMessage("Shh... Wobbles is sleeping. ü§´");
                    return;
                }
                gameState.happiness = Math.min(100, gameState.happiness + 3);
                gameState.coins += 2;
                gameState.xp += 3;
                gameState.petCount++;
                
                const messages = [
                    'Hehe! That tickles! ü•∞',
                    'I love pats! ‚ù§Ô∏è',
                    'More! More! üòç',
                    'That feels so good! üíï',
                    "You're the best! üåü"
                ];
                
                showMessage(messages[Math.floor(Math.random() * messages.length)]);
                createEmoji('‚ù§Ô∏è');
                progressQuest('pet');
                updateUI();
            }

            // --- Extras ---
            
            // NEW: Games Modal
            window.openGamesModal = function() {
                ui.gamesModal.style.display = 'block';
            }

            window.openMemoryGame = function() {
                if (gameState.energy < 10) {
                    showMessage("I'm too tired for games! üò¥ (Needs 10 Energy)");
                    return;
                }
                if (memoryGameActive) {
                    ui.memoryModal.style.display = 'block';
                    return;
                }
                
                closeModal('gamesModal'); // Close selection modal
                gameState.energy = Math.max(0, gameState.energy - 10);
                progressQuest('game');
                updateUI();
                
                ui.memoryModal.style.display = 'block';
                startMemoryGame();
            }

            window.startMemoryGame = function() {
                memoryGameActive = true;
                pairsMatched = 0;
                lockBoard = false;
                firstCard = null;
                secondCard = null;
                ui.memoryMessage.textContent = "Match all the pairs!";
                ui.memoryGrid.innerHTML = '';

                let cards = [...cardEmojis, ...cardEmojis];
                cards.sort(() => 0.5 - Math.random());

                cards.forEach(emoji => {
                    const card = document.createElement('div');
                    card.classList.add('memory-card');
                    card.dataset.emoji = emoji;

                    card.innerHTML = `
                        <div class="memory-card-face card-front">?</div>
                        <div class="memory-card-face card-back">${emoji}</div>
                    `;

                    card.addEventListener('click', flipCard);
                    card.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        flipCard(e);
                    });
                    ui.memoryGrid.appendChild(card);
                });
            }

            window.closeMemoryGame = function() {
                ui.memoryModal.style.display = 'none';
                if (memoryGameActive) {
                    showMessage("Memory Game cancelled.");
                    memoryGameActive = false;
                }
            }

            function flipCard(e) {
                const clickedCard = e.currentTarget;
                if (lockBoard || clickedCard === firstCard || clickedCard.classList.contains('is-matched')) return;

                clickedCard.classList.add('is-flipped');

                if (!firstCard) {
                    firstCard = clickedCard;
                    return;
                }

                secondCard = clickedCard;
                lockBoard = true;
                checkForMatch();
            }

            function checkForMatch() {
                let isMatch = firstCard.dataset.emoji === secondCard.dataset.emoji;
                isMatch ? disableCards() : unflipCards();
            }

            function disableCards() {
                firstCard.classList.add('is-matched');
                secondCard.classList.add('is-matched');
                
                pairsMatched++;
                if (pairsMatched === cardEmojis.length) {
                    memoryGameActive = false;
                    let coinsWon = Math.floor(Math.random() * 50) + 25;
                    let xpWon = 50;
                    gameState.coins += coinsWon;
                    gameState.xp += xpWon;
                    ui.memoryMessage.textContent = `You won! +üí∞${coinsWon} & +‚ú®${xpWon} XP!`;
                    createParticles('üéâ', 10);
                    updateUI();
                }
                
                resetBoard();
            }

            function unflipCards() {
                setTimeout(() => {
                    firstCard.classList.remove('is-flipped');
                    secondCard.classList.remove('is-flipped');
                    resetBoard();
                }, 1000);
            }

            function resetBoard() {
                [firstCard, secondCard, lockBoard] = [null, null, false];
            }

            window.openReactionGame = function() {
                if (gameState.energy < 10) {
                    showMessage("I'm too tired for games! üò¥ (Needs 10 Energy)");
                    return;
                }
                if (reactionGameState === 'running') {
                    ui.reactionModal.style.display = 'block';
                    return;
                }
                
                closeModal('gamesModal'); // Close selection modal
                gameState.energy = Math.max(0, gameState.energy - 10);
                progressQuest('game');
                updateUI();
                
                ui.reactionModal.style.display = 'block';
                setupReactionGame();
            }

            function setupReactionGame() {
                reactionGameState = 'idle';
                reactionGameScore = 0;
                reactionGameLives = 3;
                
                ui.reactionScore.textContent = reactionGameScore;
                ui.reactionLives.textContent = reactionGameLives;
                ui.reactionMessage.textContent = "Click Start to Play! (Cost: 10 Energy)";
                ui.reactionStartBtn.textContent = "Start Game";
                ui.reactionStartBtn.style.display = 'block';
                
                ui.reactionArea.innerHTML = '';
                
                if (reactionSpawnInterval) clearInterval(reactionSpawnInterval);
                if (reactionGameTimer) clearTimeout(reactionGameTimer);
            }

            window.startReactionGame = function() {
                if (reactionGameState === 'running') return;
                reactionGameState = 'running';
                
                reactionGameScore = 0;
                reactionGameLives = 3;
                ui.reactionScore.textContent = reactionGameScore;
                ui.reactionLives.textContent = reactionGameLives;

                ui.reactionStartBtn.style.display = 'none';
                ui.reactionMessage.textContent = "Catch them all!";

                reactionSpawnInterval = setInterval(spawnFruit, 1000);
                reactionGameTimer = setTimeout(endReactionGame, 30000); 
            }
            
            function spawnFruit() {
                if (reactionGameState !== 'running') return;

                const fruit = document.createElement('div');
                fruit.className = 'reaction-fruit-item';

                const fruits = ['üçì', 'üçé', 'üçâ', 'üçä', 'üçå', 'üçí'];
                fruit.textContent = fruits[Math.floor(Math.random() * fruits.length)];
                
                fruit.style.left = (Math.random() * 80 + 10) + '%';
                
                const fallSpeed = (Math.random() * 1.5 + 1.5) + 's';
                fruit.style.animation = `fall ${fallSpeed} linear forwards`;

                fruit.addEventListener('click', () => fruitClicked(fruit));
                fruit.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    fruitClicked(fruit);
                });
                fruit.addEventListener('animationend', () => fruitMissed(fruit));

                ui.reactionArea.appendChild(fruit);
            }

            function fruitClicked(fruitEl) {
                if (!fruitEl.parentNode || reactionGameState !== 'running') return; 
                fruitEl.remove();
                
                reactionGameScore += 10;
                ui.reactionScore.textContent = reactionGameScore;
            }

            function fruitMissed(fruitEl) {
                if (!fruitEl.parentNode || reactionGameState !== 'running') return; 
                fruitEl.remove();
                
                reactionGameLives--;
                ui.reactionLives.textContent = reactionGameLives;
                
                if (reactionGameLives <= 0) {
                    endReactionGame();
                }
            }
            
            function endReactionGame() {
                if (reactionGameState !== 'running') return; 
                reactionGameState = 'over';
                
                clearInterval(reactionSpawnInterval);
                clearTimeout(reactionGameTimer);

                const remainingFruits = ui.reactionArea.querySelectorAll('.reaction-fruit-item');
                remainingFruits.forEach(fruit => fruit.remove());
                
                ui.reactionStartBtn.style.display = 'block';
                ui.reactionStartBtn.textContent = 'Play Again';

                let coinsWon = reactionGameScore; 
                let xpWon = Math.floor(reactionGameScore / 2);
                gameState.coins += coinsWon;
                gameState.xp += xpWon;
                
                ui.reactionMessage.textContent = `Game Over! Score: ${reactionGameScore}! +üí∞${coinsWon} & +‚ú®${xpWon}`;
                updateUI();
            }

            window.closeReactionGame = function() {
                if (reactionGameState === 'running') {
                    endReactionGame();
                }
                reactionGameState = 'idle';
                ui.reactionModal.style.display = 'none';
            }

            window.openShop = function() {
                populateShop();
                ui.shopModal.style.display = 'block';
            }
            
            function populateShop() {
                ui.shopAccessoryGrid.innerHTML = '';
                ui.shopBackgroundGrid.innerHTML = '';

                shopItems.accessories.forEach(item => {
                    const owned = gameState.inventory.includes(item.id);
                    ui.shopAccessoryGrid.innerHTML += `
                        <div class="shop-item">
                            <div class="shop-item-icon">${item.icon}</div>
                            <span>${item.name}</span>
                            <button class="buy-btn" onclick="buyItem('${item.id}', ${item.price})" ${owned ? 'disabled' : ''}>
                                ${owned ? 'Owned' : `üí∞ ${item.price}`}
                            </button>
                        </div>
                    `;
                });

                shopItems.backgrounds.forEach(item => {
                    const owned = gameState.inventory.includes(item.id);
                    ui.shopBackgroundGrid.innerHTML += `
                        <div class="shop-item">
                            <div class="shop-item-icon">${item.icon}</div>
                            <span>${item.name}</span>
                            <button class="buy-btn" onclick="buyItem('${item.id}', ${item.price})" ${owned ? 'disabled' : ''}>
                                ${owned ? 'Owned' : `üí∞ ${item.price}`}
                            </button>
                        </div>
                    `;
                });
                
                ui.buyBtnFood.disabled = gameState.coins < 30;
            }

            window.closeShop = function() {
                ui.shopModal.style.display = 'none';
            }

            window.buyItem = function(item, cost) {
                if (gameState.coins < cost) {
                    showMessage("Not enough coins! üò¢");
                    return;
                }
                
                gameState.coins -= cost;
                
                if (item === 'food') {
                    gameState.hunger = Math.min(100, gameState.hunger + 50);
                    gameState.happiness = Math.min(100, gameState.happiness + 50);
                    gameState.health = Math.min(100, gameState.health + 50);
                    gameState.energy = Math.min(100, gameState.energy + 50);
                    showMessage("That was a SUPER meal! üçé‚ú®");
                    createParticles('üçé', 10);
                } else {
                    gameState.inventory.push(item);
                    const purchasedItem = [...shopItems.accessories, ...shopItems.backgrounds].find(i => i.id === item);
                    showMessage(`Bought ${purchasedItem.name}! ${purchasedItem.icon}`);
                    createParticles(purchasedItem.icon, 5);
                }
                
                updateUI();
                populateShop();
            }

            window.openWardrobe = function() {
                populateWardrobe();
                ui.wardrobeModal.style.display = 'block';
            }
            
            function populateWardrobe() {
                ui.wardrobeAccessoryGrid.innerHTML = '';
                ui.wardrobeBackgroundGrid.innerHTML = '';

                shopItems.accessories.forEach(item => {
                    if (gameState.inventory.includes(item.id)) {
                        let isEquipped = false;
                        if (item.id === 'tophat' || item.id === 'partyhat') {
                            isEquipped = gameState.equipped.hat === item.id;
                        } else if (item.id === 'glasses') {
                            isEquipped = gameState.equipped.glasses;
                        } else if (item.id === 'bowtie') {
                            isEquipped = gameState.equipped.bowtie;
                        } else if (item.id === 'crown') {
                            isEquipped = gameState.equipped.crown;
                        } else if (item.id === 'cape') {
                            isEquipped = gameState.equipped.cape;
                        }
                        
                        ui.wardrobeAccessoryGrid.innerHTML += `
                            <div class="wardrobe-item ${isEquipped ? 'is-equipped' : ''}">
                                <div class="wardrobe-item-icon">${item.icon}</div>
                                <span>${item.name}</span>
                                <button class="toggle-btn ${isEquipped ? 'is-equipped' : ''}" onclick="toggleEquip('${item.id}')">
                                    ${isEquipped ? 'Unequip' : 'Equip'}
                                </button>
                            </div>
                        `;
                    }
                });

                const allBgs = [{ id: 'default', name: 'Default Sky', icon: '‚òÅÔ∏è' }, ...shopItems.backgrounds];
                allBgs.forEach(item => {
                    if (gameState.inventory.includes(item.id)) {
                        const isEquipped = gameState.equipped.background === item.id;
                        ui.wardrobeBackgroundGrid.innerHTML += `
                            <div class="wardrobe-item ${isEquipped ? 'is-equipped' : ''}">
                                <div class="wardrobe-item-icon">${item.icon}</div>
                                <span>${item.name}</span>
                                <button class="toggle-btn" onclick="equipBackground('${item.id}')" ${isEquipped ? 'disabled' : ''}>
                                    ${isEquipped ? 'Equipped' : 'Equip'}
                                </button>
                            </div>
                        `;
                    }
                });
            }
            
            window.closeWardrobe = function() {
                ui.wardrobeModal.style.display = 'none';
            }
            
            window.toggleEquip = function(itemId) {
                if (itemId === 'tophat' || itemId === 'partyhat') {
                    if (gameState.equipped.hat === itemId) {
                        gameState.equipped.hat = 'none';
                    } else {
                        gameState.equipped.hat = itemId;
                    }
                } else if (itemId === 'glasses') {
                    gameState.equipped.glasses = !gameState.equipped.glasses;
                } else if (itemId === 'bowtie') {
                    gameState.equipped.bowtie = !gameState.equipped.bowtie;
                } else if (itemId === 'crown') {
                    gameState.equipped.crown = !gameState.equipped.crown;
                } else if (itemId === 'cape') {
                    gameState.equipped.cape = !gameState.equipped.cape;
                }
                
                populateWardrobe();
                updateUI();
            }
            
            window.equipBackground = function(bgId) {
                gameState.equipped.background = bgId;
                populateWardrobe();
                updateUI();
            }
            
            window.closeModal = function(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }
            
            function checkDailyReward() {
                const now = new Date();
                const today = now.toDateString();
                
                let lastRewardDate = null;
                if (gameState.lastDailyReward) {
                    lastRewardDate = new Date(gameState.lastDailyReward).toDateString();
                }

                if (today !== lastRewardDate) {
                    ui.dailyRewardBtn.style.display = 'block';
                } else {
                    ui.dailyRewardBtn.style.display = 'none';
                }
            }

            window.claimDailyReward = function() {
                gameState.coins += 100;
                gameState.lastDailyReward = new Date().toISOString();
                ui.dailyRewardBtn.style.display = 'none';
                ui.dailyRewardModal.style.display = 'block';
                updateUI();
                saveGame();
            }
            
            function assignNewQuest() {
                if (gameState.activeQuest === null) {
                    gameState.activeQuest = quests[Math.floor(Math.random() * quests.length)];
                    gameState.questProgress = 0;
                    console.log("New Quest Assigned:", gameState.activeQuest.id);
                }
                updateQuestDisplay();
            }

            function updateQuestDisplay() {
                if (gameState.activeQuest) {
                    const quest = gameState.activeQuest;
                    ui.questDisplay.textContent = `${quest.title} (${gameState.questProgress}/${quest.target})`;
                    ui.questDisplay.style.display = 'block';
                } else {
                    ui.questDisplay.style.display = 'none';
                }
            }

            function progressQuest(questType) {
                if (gameState.activeQuest && gameState.activeQuest.type === questType) {
                    gameState.questProgress++;
                    if (gameState.questProgress >= gameState.activeQuest.target) {
                        const reward = gameState.activeQuest.reward;
                        const oldQuestTitle = gameState.activeQuest.title;
                        showMessage(`Quest Complete: ${oldQuestTitle}! +üí∞${reward} Coins!`);
                        gameState.coins += reward;
                        gameState.activeQuest = null;
                        gameState.questProgress = 0;
                        setTimeout(assignNewQuest, 5000);
                    }
                    updateQuestDisplay();
                }
            }

            function init() {
                loadGame();
                updateUI();
                checkDailyReward();
                assignNewQuest();
                setInterval(gameLoop, 1000);
                registerPWA();
            }

            init();

            // --- PWA Setup ---
            function registerPWA() {
                // --- APK FIX 3: Conditional PWA ---
                if ('serviceWorker' in navigator && !window.location.protocol.startsWith('file')) {
                    // 1. Create Manifest
                    const manifest = {
                        "name": "Wobbles - Virtual Pet",
                        "short_name": "Wobbles",
                        "start_url": ".",
                        "display": "standalone",
                        "background_color": "#667eea",
                        "theme_color": "#4facfe",
                        "description": "A fun virtual pet game.",
                        "icons": [
                            {
                                "src": "https://pbs.twimg.com/media/G4x4K1HXAAAPy5X?format=png&name=small",
                                "sizes": "192x192",
                                "type": "image/png"
                            },
                            {
                                "src": "https://pbs.twimg.com/media/G4x4K1HXAAAPy5X?format=png&name=small",
                                "sizes": "512x512",
                                "type": "image/png"
                            }
                        ]
                    };
                    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                    const manifestUrl = URL.createObjectURL(manifestBlob);
                    document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestUrl}">`);

                    // 2. Register Service Worker
                    const swCode = `
                        const CACHE_NAME = 'wobbles-cache-v1';
                        const urlsToCache = [
                            '${location.href}',
                            'https://pbs.twimg.com/media/G4x4K1HXAAAPy5X?format=png&name=small'
                        ];

                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => {
                                        console.log('Opened cache');
                                        return cache.addAll(urlsToCache).catch(err => {
                                            console.warn('Failed to cache all URLs:', err);
                                            return Promise.all(urlsToCache.map(url => {
                                                return cache.add(url).catch(addErr => {
                                                    console.warn('Failed to cache:', url, addErr);
                                                });
                                            }));
                                        });
                                    })
                            );
                        });

                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        if (response) {
                                            return response;
                                        }
                                        return fetch(event.request).then(
                                            networkResponse => {
                                                if(!networkResponse || networkResponse.status !== 200 || networkResponse.type !== 'basic') {
                                                    return networkResponse;
                                                }
                                                const responseToCache = networkResponse.clone();
                                                caches.open(CACHE_NAME)
                                                    .then(cache => {
                                                        cache.put(event.request, responseToCache);
                                                    });
                                                return networkResponse;
                                            }
                                        );
                                    }
                                )
                            );
                        });

                        self.addEventListener('activate', event => {
                            const cacheWhitelist = [CACHE_NAME];
                            event.waitUntil(
                                caches.keys().then(cacheNames => {
                                    return Promise.all(
                                        cacheNames.map(cacheName => {
                                            if (cacheWhitelist.indexOf(cacheName) === -1) {
                                                return caches.delete(cacheName);
                                            }
                                        })
                                    );
                                })
                            );
                        });
                    `;
                    
                    try {
                        const blob = new Blob([swCode], { type: 'application/javascript' });
                        const swUrl = URL.createObjectURL(blob);
                        navigator.serviceWorker.register(swUrl)
                            .then(registration => {
                                console.log('ServiceWorker registration successful with scope: ', registration.scope);
                            })
                            .catch(err => {
                                console.log('ServiceWorker registration failed: ', err);
                            });
                    } catch (e) {
                        console.error('Error creating ServiceWorker Blob:', e);
                    }
                } else {
                    console.log('PWA Service Worker not registered (running on file:// or not supported).');
                }
            }
        }); // --- END: DOMContentLoaded ---
    </script>
</body>
</html>

